<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/cell-32x32-next.png"><link rel="icon" href="/img/cell-32x32-next.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="laser"><meta name="keywords" content=""><meta name="description" content="1.异常类型 point outliers（点异常）：这种异常样本往往以单个点的形式存在，其数值相较于整体样本而言是明显异常的（例如异常大或异常小的全局异常）。  contextual outliers（上下文异常）：contextual outlier的异常体现在某一段时间区间。例如下图的第二幅子图，该异常点相对于整体样本而言并无异常，但如果考虑其相邻时间内的样本，其有明显的异常特性。"><meta property="og:type" content="article"><meta property="og:title" content="时间序列集体异常检测与DBSCAN实战"><meta property="og:url" content="https://haochendaily.com/collective-anomaly-and-dbscan.html"><meta property="og:site_name" content="haochenBlog"><meta property="og:description" content="1.异常类型 point outliers（点异常）：这种异常样本往往以单个点的形式存在，其数值相较于整体样本而言是明显异常的（例如异常大或异常小的全局异常）。  contextual outliers（上下文异常）：contextual outlier的异常体现在某一段时间区间。例如下图的第二幅子图，该异常点相对于整体样本而言并无异常，但如果考虑其相邻时间内的样本，其有明显的异常特性。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/1.1p11ki2gci80.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/2.5ttokbw5tz00.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/3.36x9yqdo7280.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/4.50ewczun4dc0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/4.4a1wi33d3o20.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/5.3cmrrg0tjgu0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/6.3ph5oy7aiym0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/7.6znotbvxhto0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/8.36lgllzomlk0.jpg"><meta property="article:published_time" content="2022-05-14T10:22:06.284Z"><meta property="article:modified_time" content="2022-05-14T13:09:03.492Z"><meta property="article:author" content="laser"><meta property="article:tag" content="集体异常"><meta property="article:tag" content="子序列聚类"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/1.1p11ki2gci80.jpg"><meta name="referrer" content="no-referrer-when-downgrade"><title>时间序列集体异常检测与DBSCAN实战 - haochenBlog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"haochendaily.com",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"C"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"left",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="haochenBlog" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>EASY</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://cdn.staticaly.com/gh/fight-ing-go/image_repository@master/wallpaper_img/wallhaven-72ywpv_1920x1080.1t8ds73xt2yo.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="时间序列集体异常检测与DBSCAN实战"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-05-14 18:22" pubdate>2022年5月14日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 7k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 59 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="padding-left:2rem;margin-right:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">时间序列集体异常检测与DBSCAN实战</h1><div class="markdown-body"><h1 id="1-异常类型"><a href="#1-异常类型" class="headerlink" title="1.异常类型"></a>1.异常类型</h1><ul><li><p><strong>point outliers（点异常）</strong>：这种异常样本往往以单个点的形式存在，其数值相较于整体样本而言是明显异常的（例如异常大或异常小的全局异常）。</p></li><li><p><strong>contextual outliers（上下文异常）</strong>：contextual outlier的异常体现在某一段时间区间。例如下图的第二幅子图，该异常点相对于整体样本而言并无异常，但如果考虑其相邻时间内的样本，其有明显的异常特性。</p><span id="more"></span></li><li><p><strong>collective outliers（集体异常）</strong>：指一段时间序列数据为异常。且该段数据中单独看每个样本点都不是异常的，样本的异常性体现在该段数据整体而言是异常的。<br><img src="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/1.1p11ki2gci80.jpg" srcset="/img/loading.gif" lazyload alt="1"></p></li></ul><h1 id="2-集体异常检测"><a href="#2-集体异常检测" class="headerlink" title="2.集体异常检测"></a>2.集体异常检测</h1><p>检测集体（模式）异常的常见做法：</p><ul><li><strong>不和谐分析</strong>：利用滑动窗口将时间序列分割成多个子序列，并计算子序列之间的距离（例如，欧几里德距离）以找到时间序列数据中的不和谐，如矩阵配置文件、HotSAX。</li><li><strong>子序列聚类</strong>：也将子序列分割应用于时间序列数据，并采用子序列作为每个时间点的特征，其中滑动窗口的大小是特征的数量。然后，采用无监督机器学习方法，例如聚类（例如，Kmeans，PCA）或逐点异常值检测算法来检测模式异常值。<br>其中，基于子序列的方法有三种不同的检测策略：<br>基于模型的方法：每个时间序列被转换为模型参数，然后选择合适的模型距离和聚类算法(通常是传统的聚类算法)，并将其应用于提取的模型参数。<br>基于特征的方法：通常在这种方法中，先从每个时间序列中计算等长特征向量，然后进行欧氏距离测量。<br>基于形状的方法：通常直接处理原始时间序列数据。依据序列间的距离/相似度度量进行聚类<h1 id="3-集体异常检测实战"><a href="#3-集体异常检测实战" class="headerlink" title="3.集体异常检测实战"></a>3.集体异常检测实战</h1>检测策略：基于特征的子序列聚类，PCA提取重要特征，DBSCAN算法实现聚类。<br>检测流程：</li></ul><ol><li>加载原始数据</li><li>为了提高检测效果，对数据进行滤波平滑处理。</li><li>去除数据趋势影响。</li><li>按照实际数据模式，划分子序列，并提取特征。</li><li>特征过滤，PCA降维。</li><li>DBSCAN聚类，检测异常序列。<br>首先加载必要的工具并加载数据。</li></ol><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np <br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd <br><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> signal<br><span class="hljs-keyword">import</span> random <span class="hljs-keyword">as</span> rd <br><span class="hljs-keyword">import</span> datetime <br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt <br><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns<br><span class="hljs-keyword">import</span> matplotlib.dates <span class="hljs-keyword">as</span> mdate<br><span class="hljs-keyword">import</span> warnings<br>warnings.filterwarnings(<span class="hljs-string">"ignore"</span>)<br><span class="hljs-keyword">from</span> tsfresh.utilities.dataframe_functions <span class="hljs-keyword">import</span> roll_time_series<br><span class="hljs-keyword">from</span> statsmodels.tsa.seasonal <span class="hljs-keyword">import</span> seasonal_decompose<br><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler<br><span class="hljs-keyword">from</span> sklearn.feature_selection <span class="hljs-keyword">import</span> VarianceThreshold   <br><span class="hljs-keyword">from</span> tsfresh <span class="hljs-keyword">import</span> extract_features<br><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> signal<br><span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> PCA<br><span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> NearestNeighbors<br><span class="hljs-keyword">from</span> sklearn.cluster <span class="hljs-keyword">import</span> DBSCAN<br><span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> metrics<br><span class="hljs-keyword">import</span> plotly.graph_objs <span class="hljs-keyword">as</span> go<br><br><span class="hljs-comment">#加载资源文件数据</span><br>data = pd.read_csv(<span class="hljs-string">'./Data.csv'</span>)<br>data.index = pd.to_datetime(data.Datetime)<br></code></pre></td></tr></tbody></table></figure><p>使用低通滤波器滤波。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">b, a = signal.butter(<span class="hljs-number">10</span>,<span class="hljs-number">0.026</span> , <span class="hljs-string">'lowpass'</span>) <span class="hljs-comment">#配置滤波器 8 表示滤波器的阶数</span><br>data[<span class="hljs-string">'Hu1_0'</span>] = signal.filtfilt(b, a, data[<span class="hljs-string">'Hu_0'</span>]) <span class="hljs-comment">#data为要过滤的信号</span><br><span class="hljs-comment">#可视化</span><br>plt.figure(figsize=(<span class="hljs-number">20</span>,<span class="hljs-number">5</span>))<br>plt.title(<span class="hljs-string">'Hu_0'</span>)<br>plt.plot(data[<span class="hljs-string">'Hu1_0'</span>])<br>plt.plot(data[<span class="hljs-string">'Hu_0'</span>])<br></code></pre></td></tr></tbody></table></figure><p>结果曲线图如下：<br><img src="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/2.5ttokbw5tz00.jpg" srcset="/img/loading.gif" lazyload alt="2"></p><p>利用时间序列分解，去除曲线趋势。在前期数据分析时找出数据存在两个周期，77min和1day。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 去趋势</span><br>decompose_result = seasonal_decompose(data[<span class="hljs-string">'Hu1_0'</span>], model=<span class="hljs-string">"additive"</span>, period=<span class="hljs-number">77</span>)<br><span class="hljs-comment"># 分离77周期</span><br>data[<span class="hljs-string">"detrend_77"</span>] = data[<span class="hljs-string">'Hu1_0'</span>] - decompose_result.seasonal<br><span class="hljs-comment">#分解1440周期</span><br>decompose_result = seasonal_decompose(data[<span class="hljs-string">"detrend_77"</span>] , model=<span class="hljs-string">"additive"</span>, period=<span class="hljs-number">1440</span>)<br><span class="hljs-comment"># 趋势分量</span><br>data[<span class="hljs-string">"Hu0_trend"</span>] = decompose_result.trend<br><span class="hljs-comment">#删除含空值的行，前面分解的序列前端末端含有空值。</span><br>data = data.dropna(axis=<span class="hljs-number">0</span>)<br><span class="hljs-comment">#去除趋势</span><br>data[<span class="hljs-string">'detrend_Hu0'</span>] = data[<span class="hljs-string">'Hu1_0'</span>] - decompose_result.trend<br><span class="hljs-comment"># 可视化</span><br>plt.figure(figsize=(<span class="hljs-number">20</span>,<span class="hljs-number">10</span>))<br>plt.title(<span class="hljs-string">'Hu_0'</span>)<br>plt.plot(data[<span class="hljs-string">'detrend_Hu0'</span>])<br></code></pre></td></tr></tbody></table></figure><div align="center"><img src="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/3.36x9yqdo7280.jpg" srcset="/img/loading.gif" lazyload width="60%/"></div><p>接下来按照77窗口大小划分子序列，无重复窗口，并提取每个子序列的特征。使用tsfresh工具包，按照API要求，在表中添加id列。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">data[<span class="hljs-string">'id'</span>] = <span class="hljs-number">1</span><br><span class="hljs-comment"># 滚动窗口</span><br><span class="hljs-comment">#max_timeshift:最大偏移量，min_timeshift：最小偏移量，rolling_direction：每次移动的大小和方向。column_sort:按什么排序，默认已从小到大排好</span><br>df_rolled = roll_time_series(data, column_id=<span class="hljs-string">"id"</span>, column_sort=<span class="hljs-string">"time"</span>,max_timeshift = <span class="hljs-number">76</span> ,min_timeshift = <span class="hljs-number">76</span>,rolling_direction=-<span class="hljs-number">77</span>)<br><span class="hljs-comment"># 特征提取</span><br>df_features = extract_features(df_rolled.drop(<span class="hljs-string">"time"</span>,axis = <span class="hljs-number">1</span>), column_id=<span class="hljs-string">"id"</span>)<br></code></pre></td></tr></tbody></table></figure><p>利用方差和相关系数进行特征过滤。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#删除含空值列</span><br>df_features_dropna_All = df_features.dropna(axis=<span class="hljs-number">1</span>)<br><span class="hljs-comment"># 标准化</span><br>scaler1 = StandardScaler()<br>df_features_Standar = pd.DataFrame(scaler1.fit_transform(df_features_dropna_All),index=df_features_dropna_All.index, columns=df_features_dropna_All.columns)<br>df_features_Standar<br><span class="hljs-comment"># 特征过滤 filter方差</span><br>X_fratures_columns = df_features_Standar.columns<br>selector = VarianceThreshold(<span class="hljs-number">0.9</span>)<br>X_features = selector.fit_transform(df_features_Standar)<br>df_features_filter = pd.DataFrame(X_features,index=df_features_Standar.index, columns=X_fratures_columns[selector.get_support(indices=<span class="hljs-literal">True</span>)])<br><span class="hljs-comment"># 特征过滤 相关系数corr</span><br><span class="hljs-comment"># 剔除相关性系数高于threshold的corr_drop</span><br><span class="hljs-comment"># df_filter.corr()</span><br>corr_features = df_features_filter.corr()<br>threshold = <span class="hljs-number">0.4</span><br>upper_features = corr_features.where(np.triu(np.ones(corr_features.shape), k=<span class="hljs-number">1</span>).astype(np.<span class="hljs-built_in">bool</span>))<br>corr_features_drop = [column <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> upper_features.columns <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(upper_features[column].<span class="hljs-built_in">abs</span>() &gt; threshold)]<br>df_features_filter = df_features_filter.drop(corr_features_drop,axis=<span class="hljs-number">1</span>)<br>df_features_filter<br></code></pre></td></tr></tbody></table></figure><p>过滤后的特征有14个，再使用PCA特征降维。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># PCA降维,目标维数为7。</span><br>pca = PCA(n_components=<span class="hljs-number">7</span>)<br>pca.fit(df_features_filter)<br><span class="hljs-comment">#获取特征主成分占比</span><br>variance = pca.explained_variance_ratio_ <br>var=np.cumsum(np.<span class="hljs-built_in">round</span>(variance, <span class="hljs-number">3</span>)*<span class="hljs-number">100</span>)<br>plt.figure(figsize=(<span class="hljs-number">12</span>,<span class="hljs-number">6</span>))<br>plt.ylabel(<span class="hljs-string">'% Variance Explained'</span>)<br>plt.xlabel(<span class="hljs-string">'# of Features'</span>)<br>plt.title(<span class="hljs-string">'PCA Analysis'</span>)<br>plt.ylim(<span class="hljs-number">0</span>,<span class="hljs-number">100.5</span>)<br>plt.plot(var)<br></code></pre></td></tr></tbody></table></figure><p>画出特征主成分占比曲线图。</p><div align="center"><img src="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/4.50ewczun4dc0.jpg" srcset="/img/loading.gif" lazyload width="60%/"></div><p>选择占比最大的三个特征。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">pca = PCA(n_components=<span class="hljs-number">3</span>)<br>pca.fit(df_features_filter)<br>pca_scale = pca.transform(df_features_filter)<br>pca_df = pd.DataFrame(pca_scale, columns=[<span class="hljs-string">'pc1'</span>, <span class="hljs-string">'pc2'</span>, <span class="hljs-string">'pc3'</span>])<br><span class="hljs-built_in">print</span>(pca.explained_variance_ratio_)<br>pca_df <br></code></pre></td></tr></tbody></table></figure><div align="center"><img src="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/4.4a1wi33d3o20.jpg" srcset="/img/loading.gif" lazyload width="25%/"></div><p>查看特征3D图。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">Scene = <span class="hljs-built_in">dict</span>(xaxis = <span class="hljs-built_in">dict</span>(title = <span class="hljs-string">'PC1'</span>),yaxis = <span class="hljs-built_in">dict</span>(title = <span class="hljs-string">'PC2'</span>),zaxis = <span class="hljs-built_in">dict</span>(title = <span class="hljs-string">'PC3'</span>))<br>trace = go.Scatter3d(x=pca_df.iloc[:,<span class="hljs-number">0</span>], y=pca_df.iloc[:,<span class="hljs-number">1</span>], z=pca_df.iloc[:,<span class="hljs-number">2</span>], mode=<span class="hljs-string">'markers'</span>,marker=<span class="hljs-built_in">dict</span>(colorscale=<span class="hljs-string">'Greys'</span>, opacity=<span class="hljs-number">0.6</span>, size = <span class="hljs-number">10</span>))<br>layout = go.Layout(margin=<span class="hljs-built_in">dict</span>(l=<span class="hljs-number">0</span>,r=<span class="hljs-number">0</span>),scene = Scene, height = <span class="hljs-number">1000</span>,width = <span class="hljs-number">1000</span>)<br>data = [trace]<br>fig = go.Figure(data = data, layout = layout)<br>fig.show()<br></code></pre></td></tr></tbody></table></figure><div align="center"><img src="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/5.3cmrrg0tjgu0.jpg" srcset="/img/loading.gif" lazyload width="45%/"></div><p>DBSCAN需要确定两个参数：epsilon：聚类半径；minPts：聚类点数。其中minPts一般取特征数目的两倍，对应项目中取6。epsilon利用肘形图确定。<br>画出特征的肘形图，即在y轴上，绘制点之间的平均距离，在x轴上绘制数据集中的所有数据点。从图中，取肘部数值约1.4。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">plt.figure(figsize=(<span class="hljs-number">10</span>,<span class="hljs-number">5</span>))<br>nn = NearestNeighbors(n_neighbors=<span class="hljs-number">6</span>).fit(pca_df)<br>distances, idx = nn.kneighbors(pca_df)<br>distances = np.sort(distances, axis=<span class="hljs-number">0</span>)<br>distances = distances[:,<span class="hljs-number">1</span>]<br>plt.plot(distances)<br>plt.show()<br></code></pre></td></tr></tbody></table></figure><div align="center"><img src="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/6.3ph5oy7aiym0.jpg" srcset="/img/loading.gif" lazyload width="60%/"></div><p>确定完两个参数后，开始聚类。输出结果为聚类簇数、噪声点数和剪影得分（评价聚类效果，越接近1越好）。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">db = DBSCAN(eps=<span class="hljs-number">1.4</span>, min_samples=<span class="hljs-number">6</span>).fit(pca_df)<br>labels = db.labels_<span class="hljs-comment"># Number of clusters in labels, ignoring noise if present.</span><br>n_clusters_ = <span class="hljs-built_in">len</span>(<span class="hljs-built_in">set</span>(labels)) - (<span class="hljs-number">1</span> <span class="hljs-keyword">if</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">in</span> labels <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>)<br>n_noise_ = <span class="hljs-built_in">list</span>(labels).count(-<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">'Estimated number of clusters: %d'</span> % n_clusters_)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">'Estimated number of noise points: %d'</span> % n_noise_)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">"Silhouette Coefficient: %0.3f"</span> % metrics.silhouette_score(pca_df, labels))<br></code></pre></td></tr></tbody></table></figure><p>输出结果：<br>Estimated number of clusters: 1<br>Estimated number of noise points: 10<br>Silhouette Coefficient: 0.528<br>将筛选出来的噪声点即异常点反映在3D图上。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">Scene = <span class="hljs-built_in">dict</span>(xaxis = <span class="hljs-built_in">dict</span>(title = <span class="hljs-string">'PC1'</span>),yaxis = <span class="hljs-built_in">dict</span>(title = <span class="hljs-string">'PC2'</span>),zaxis = <span class="hljs-built_in">dict</span>(title = <span class="hljs-string">'PC3'</span>))<br>labels = db.labels_<br>trace = go.Scatter3d(x=pca_df.iloc[:,<span class="hljs-number">0</span>], y=pca_df.iloc[:,<span class="hljs-number">1</span>], z=pca_df.iloc[:,<span class="hljs-number">2</span>], mode=<span class="hljs-string">'markers'</span>,marker=<span class="hljs-built_in">dict</span>(color = labels, colorscale=<span class="hljs-string">'Viridis'</span>, size = <span class="hljs-number">10</span>, line = <span class="hljs-built_in">dict</span>(color = <span class="hljs-string">'gray'</span>,width = <span class="hljs-number">5</span>)))<br>layout = go.Layout(scene = Scene, height = <span class="hljs-number">1000</span>,width = <span class="hljs-number">1000</span>)<br>data = [trace]<br>fig = go.Figure(data = data, layout = layout)<br>fig.update_layout(title=<span class="hljs-string">'DBSCAN clusters Derived from PCA'</span>, font=<span class="hljs-built_in">dict</span>(size=<span class="hljs-number">12</span>,))<br>fig.show()<br></code></pre></td></tr></tbody></table></figure><div align="center"><img src="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/7.6znotbvxhto0.jpg" srcset="/img/loading.gif" lazyload width="45%/"></div><p>将筛选出的异常序列反映到时间序列中。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">df_rolled[<span class="hljs-string">'id'</span>] = <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-built_in">len</span>(df_rolled)+<span class="hljs-number">1</span>)<br>df_rolled.index = df_rolled.<span class="hljs-built_in">id</span><br>plt.figure(figsize=(<span class="hljs-number">20</span>,<span class="hljs-number">10</span>))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(labels)-<span class="hljs-number">1</span>):<br>    <span class="hljs-keyword">if</span> labels[i]&gt;-<span class="hljs-number">1</span>:<br>        data = df_rolled[i*<span class="hljs-number">77</span>:(i+<span class="hljs-number">1</span>)*<span class="hljs-number">77</span>]<br>        plt.plot(data[<span class="hljs-string">'time'</span>],data[<span class="hljs-string">'detrend_Hu0'</span>],color=<span class="hljs-string">'blue'</span>)<br>    <span class="hljs-keyword">else</span>:<br>        data = df_rolled[i*<span class="hljs-number">77</span>:(i+<span class="hljs-number">1</span>)*<span class="hljs-number">77</span>]<br>        plt.plot(data[<span class="hljs-string">'time'</span>],data[<span class="hljs-string">'detrend_Hu0'</span>],color=<span class="hljs-string">'red'</span>)<br>plt.show()<br>plt.figure(figsize=(<span class="hljs-number">20</span>,<span class="hljs-number">10</span>))<br>plt.title(<span class="hljs-string">'Hu_0'</span>)<br>plt.plot(df_rolled[<span class="hljs-string">'detrend_Hu0'</span>])<br>plt.show()<br></code></pre></td></tr></tbody></table></figure><div align="center"><img src="https://cdn.jsdelivr.net/gh/fight-ing-go/image_repository@master/202205/Collective-anomaly-And-DBSCAN/8.36lgllzomlk0.jpg" srcset="/img/loading.gif" lazyload width="60%/"></div></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" class="category-chain-item">机器学习</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E9%9B%86%E4%BD%93%E5%BC%82%E5%B8%B8/">#集体异常</a> <a href="/tags/%E5%AD%90%E5%BA%8F%E5%88%97%E8%81%9A%E7%B1%BB/">#子序列聚类</a></div></div><div class="license-box my-3"><div class="license-title"><div>时间序列集体异常检测与DBSCAN实战</div><div>https://haochendaily.com/collective-anomaly-and-dbscan.html</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>laser</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年5月14日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/multithreaded-development.html" title="Linux多线程的一些知识点"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Linux多线程的一些知识点</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/installing-mariadb-with-bat-in-windows-7-environment.html" title="Windows7环境bat安装mariadb"><span class="hidden-mobile">Windows7环境bat安装mariadb</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.4.17/Valine.min.js",(function(){var i=Object.assign({appId:"TSl5PlExO22wiwkA3e15kGvM-gzGzoHsz",appKey:"36AERjunsq15rL0xcz3ovKbG",path:"window.location.pathname",placeholder:"尽情吐槽吧~",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>